name: check-diff
on: 
  push:
  pull_request:
    branches:
      - "main"
      - "develop"
    paths-ignore:
      - "docs/**"
      - "**.md"
env:
  WORKSPACE_PREFIX: $(echo $GITHUB_WORKSPACE |cut -d '/' -f 1-4)
  SLURM_PARTITION: "[{'./internlm/train/train_internlm.py':['init_logger','check_loder','read_dataset']},{'./internlm/utils':['model.py','log.py']}]"

jobs:
  check-requirements:
    runs-on: [ubuntu-latest]
    steps:
    - name: mask env
      run: |
        echo "::add-mask::${{env.WORKSPACE_PREFIX}}"
    - uses: actions/checkout@v3
      with:
         fetch-depth: 2
    - name: check-requirements
      run: |
        echo "beging test"
        changed_files=$(git diff --name-only -r HEAD^1 HEAD)
        echo $changed_files
        git diff --color HEAD^1 HEAD |tee  origin.log
        echo "***************"
        cat origin.log
        echo -e "\033[45;37m $(cat origin.log) \033[0m"

  debug-env:
    runs-on: [ubuntu-latest]
    steps:
    - name: mask env
      run: |
        echo "::add-mask::${{env.WORKSPACE_PREFIX}}"
    - uses: actions/checkout@v3
      with:
         fetch-depth: 2
    - name: check-variables
      run: |
        echo ${{env.SLURM_PARTITION}}
        echo ${{env.SLURM_PARTITION}} >> tmp.json
        jq -r .[0] tmp.json
        echo ${{env.SLURM_PARTITION}} |jq -r .[0]

  debug-env_2:
    runs-on: [ubuntu-latest]
    steps:
    - name: mask env
      run: |
        echo "::add-mask::${{env.WORKSPACE_PREFIX}}"
    - uses: actions/checkout@v3
      with:
         fetch-depth: 2
    - name: check-variables
      run: |
        jq -r .[0] ci_scripts/common/check_info.json
        echo "env info in secret"
        echo ${{ env.FEISHU_ADDRESS }}
        echo ${{ secrets.FEISHU_IP }}
